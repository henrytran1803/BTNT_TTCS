CREATE FUNCTION dbo.LayDanhSach_tpnt_CTL_fn
(
    @MACTL nchar(8)
)
RETURNS TABLE
AS
RETURN
(
    SELECT TP.MATPNT, TP.TENTP
    FROM TPNT TP
    WHERE TP.MATPNT NOT IN (
        SELECT TL.MATPNT
        FROM CT_CTL TL
        JOIN CUOC_TRIEN_LAM C ON TL.MACTL = C.MACTL
        WHERE (C.NGAYBATDAU < (SELECT NGAYBATDAU FROM CUOC_TRIEN_LAM WHERE MACTL = @MACTL) AND C.NGAYKETTHUC > (SELECT NGAYKETTHUC FROM CUOC_TRIEN_LAM WHERE MACTL = @MACTL))
            OR (C.NGAYBATDAU < (SELECT NGAYBATDAU FROM CUOC_TRIEN_LAM WHERE MACTL = @MACTL) AND C.NGAYKETTHUC < (SELECT NGAYKETTHUC FROM CUOC_TRIEN_LAM WHERE MACTL = @MACTL))
            OR (C.NGAYBATDAU > (SELECT NGAYBATDAU FROM CUOC_TRIEN_LAM WHERE MACTL = @MACTL) AND C.NGAYKETTHUC < (SELECT NGAYKETTHUC FROM CUOC_TRIEN_LAM WHERE MACTL = @MACTL))
    )
)
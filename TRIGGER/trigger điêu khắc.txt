CREATE TRIGGER trg_InsertDIEU_KHAC
ON DIEU_KHAC
INSTEAD OF INSERT
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (
        SELECT 1
        FROM inserted I
        LEFT JOIN TPNT T ON I.MATPNT = T.MATPNT
        LEFT JOIN HOI_HOA HH ON I.MATPNT = HH.MATPNT
        LEFT JOIN KHAC K ON I.MATPNT = K.MATPNT
        WHERE T.MATPNT IS NULL OR HH.MATPNT IS NOT NULL OR K.MATPNT IS NOT NULL
    )
    BEGIN
        RAISERROR('MATPNT không tồn tại hoặc có liên kết với bảng HOI_HOA hoặc KHAC', 16, 1);
    END
    ELSE
    BEGIN
        INSERT INTO DIEU_KHAC (MATPNT, MAVL, KHOILUONG, CHIEUCAO, MAPC)
        SELECT MATPNT, MAVL, KHOILUONG, CHIEUCAO, MAPC
        FROM inserted;
    END
END

CREATE TRIGGER trg_InsertKHAC
ON KHAC
INSTEAD OF INSERT
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (
        SELECT 1
        FROM inserted I
        LEFT JOIN TPNT T ON I.MATPNT = T.MATPNT
        LEFT JOIN HOI_HOA HH ON I.MATPNT = HH.MATPNT
        LEFT JOIN DIEU_KHAC DK ON I.MATPNT = DK.MATPNT
        WHERE T.MATPNT IS NULL OR HH.MATPNT IS NOT NULL OR DK.MATPNT IS NOT NULL
    )
    BEGIN
        RAISERROR('MATPNT không tồn tại hoặc có liên kết với bảng HOI_HOA hoặc DIEU_KHAC', 16, 1);
    END
    ELSE
    BEGIN
        INSERT INTO KHAC (MATPNT, MAPC, ANH)
        SELECT MATPNT, MAPC, ANH
        FROM inserted;
    END
END

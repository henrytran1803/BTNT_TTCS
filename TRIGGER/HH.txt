CREATE TRIGGER trg_InsertHOI_HOA
ON HOI_HOA
INSTEAD OF INSERT
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (
        SELECT 1
        FROM inserted I
        LEFT JOIN TPNT T ON I.MATPNT = T.MATPNT
        LEFT JOIN DIEU_KHAC DK ON I.MATPNT = DK.MATPNT
        LEFT JOIN KHAC K ON I.MATPNT = K.MATPNT
        WHERE T.MATPNT IS NULL OR DK.MATPNT IS NOT NULL OR K.MATPNT IS NOT NULL
    )
    BEGIN
        RAISERROR('MATPNT không tồn tại hoặc có liên kết với bảng DIEU_KHAC hoặc KHAC', 16, 1);
    END
    ELSE
    BEGIN
        INSERT INTO HOI_HOA (MATPNT, MACL, MAVL, MATP)
        SELECT MATPNT, MACL, MAVL, MATP
        FROM inserted;
    END
END
